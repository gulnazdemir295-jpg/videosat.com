<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Channel Room Test - VideoSat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://player.live-video.net/1.42.0/amazon-ivs-player.min.js"></script>
    <!-- AWS IVS Broadcast SDK - jsDelivr CDN -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-ivs-web-broadcast@1.28.0/dist/amazon-ivs-web-broadcast.min.js" 
            onerror="console.error('âŒ AWS IVS Broadcast SDK yÃ¼klenemedi! CDN eriÅŸim hatasÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.'); window.ivsSDKError = true;"
            onload="console.log('âœ… AWS IVS Broadcast SDK yÃ¼klendi'); window.ivsSDKLoaded = true;"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #dc2626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            background: #dc2626;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .video-section {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #404040;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
            border: 2px solid #dc2626;
        }

        #mainVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .video-info h3 {
            color: #dc2626;
            margin-bottom: 10px;
        }

        .video-info p {
            color: #999;
            font-size: 14px;
            margin: 5px 0;
        }

        .channels-sidebar {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #404040;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .channels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .channels-header h2 {
            color: #ffffff;
            font-size: 18px;
        }

        .refresh-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .refresh-btn:hover {
            background: #b91c1c;
        }

        .channel-card {
            background: #0a0a0a;
            border: 1px solid #404040;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .channel-card:hover {
            border-color: #dc2626;
            transform: translateX(5px);
        }

        .channel-card.active {
            border-color: #dc2626;
            background: #1a0000;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .channel-name {
            font-weight: 600;
            color: #ffffff;
        }

        .channel-status {
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-status.inactive {
            background: #666;
        }

        .channel-info {
            color: #999;
            font-size: 12px;
            margin: 5px 0;
        }

        .control-panel {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #404040;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .control-group input {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #404040;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .log-container {
            background: #0a0a0a;
            border: 1px solid #404040;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.info { color: #3b82f6; }
        .log-entry.warning { color: #f59e0b; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #404040;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-tv"></i>
                Multi-Channel Room Test
            </h1>
            <div class="status-badge" id="connectionStatus">
                <i class="fas fa-circle"></i>
                BaÄŸlantÄ± Kontrol Ediliyor...
            </div>
        </div>

        <div class="main-grid">
            <!-- Ana Video Player -->
            <div class="video-section">
                <div class="video-container">
                    <video id="mainVideo" autoplay muted></video>
                </div>
                <div class="video-info">
                    <h3 id="currentChannelName">HenÃ¼z kanal seÃ§ilmedi</h3>
                    <p id="currentChannelInfo">Bir kanal seÃ§erek yayÄ±nÄ± izlemeye baÅŸlayÄ±n</p>
                    <p id="currentPlaybackUrl" style="word-break: break-all; font-size: 11px; color: #666;"></p>
                </div>
            </div>

            <!-- Channel List Sidebar -->
            <div class="channels-sidebar">
                <div class="channels-header">
                    <h2><i class="fas fa-list"></i> Aktif Kanallar</h2>
                    <button class="refresh-btn" onclick="loadChannels()">
                        <i class="fas fa-sync-alt"></i> Yenile
                    </button>
                </div>
                <div id="channelsList">
                    <div class="empty-state">
                        <i class="fas fa-tv"></i>
                        <p>HenÃ¼z kanal yok</p>
                        <p style="font-size: 12px; margin-top: 10px;">YayÄ±ncÄ±lar room'a katÄ±ldÄ±ÄŸÄ±nda burada gÃ¶rÃ¼necek</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2 style="color: #ffffff; margin-bottom: 20px;">
                <i class="fas fa-cog"></i> Test Kontrolleri
            </h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Room AyarlarÄ± -->
                <div class="control-group">
                    <label><i class="fas fa-door-open"></i> Room ID</label>
                    <input type="text" id="roomIdInput" value="videosat-showroom-2024" placeholder="room-id">
                </div>

                <!-- YayÄ±ncÄ± Olarak KatÄ±l -->
                <div class="control-group">
                    <label><i class="fas fa-broadcast-tower"></i> YayÄ±ncÄ± E-posta</label>
                    <input type="email" id="streamerEmailInput" value="test-streamer@videosat.com" placeholder="streamer@example.com">
                </div>

                <div class="control-group">
                    <label><i class="fas fa-user"></i> YayÄ±ncÄ± Ä°smi</label>
                    <input type="text" id="streamerNameInput" value="Test YayÄ±ncÄ±" placeholder="YayÄ±ncÄ± Ä°smi">
                </div>

                <div class="control-group">
                    <label><i class="fas fa-mobile-alt"></i> Cihaz Bilgisi</label>
                    <input type="text" id="deviceInfoInput" value="Test Device" placeholder="iPhone, MacBook, vb.">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="joinRoomAsStreamer()">
                    <i class="fas fa-broadcast-tower"></i> Room'a KatÄ±l (OBS/Stream Key iÃ§in)
                </button>
                <button class="btn btn-primary" onclick="startBrowserStream()" style="background: #059669;">
                    <i class="fas fa-video"></i> TarayÄ±cÄ±dan YayÄ±n BaÅŸlat
                </button>
                <button class="btn btn-secondary" onclick="loadChannels()">
                    <i class="fas fa-list"></i> KanallarÄ± YÃ¼kle
                </button>
                <button class="btn btn-success" onclick="createRoom()">
                    <i class="fas fa-plus"></i> Room OluÅŸtur (Admin)
                </button>
            </div>
            
            <!-- TarayÄ±cÄ± YayÄ±n Kontrolleri -->
            <div id="browserStreamControls" style="display: none; margin-top: 20px; padding: 20px; background: #0a0a0a; border-radius: 10px; border: 1px solid #404040;">
                <h3 style="color: #ffffff; margin-bottom: 15px;">
                    <i class="fas fa-video"></i> TarayÄ±cÄ± YayÄ±n Kontrolleri
                </h3>
                <div style="margin-bottom: 15px;">
                    <video id="localPreview" autoplay muted style="width: 100%; max-width: 640px; border-radius: 8px; background: #000;"></video>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="stopBrowserStream()" id="stopStreamBtn" style="display: none;">
                        <i class="fas fa-stop"></i> YayÄ±nÄ± Durdur
                    </button>
                    <button class="btn btn-secondary" onclick="toggleMute()" id="muteBtn">
                        <i class="fas fa-microphone"></i> Mikrofonu Kapat/AÃ§
                    </button>
                    <button class="btn btn-secondary" onclick="toggleVideo()" id="videoBtn">
                        <i class="fas fa-video"></i> KamerayÄ± Kapat/AÃ§
                    </button>
                </div>
                <div id="streamStatus" style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 8px; font-size: 12px; color: #999;"></div>
            </div>

            <!-- AWS Credentials Test -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #404040;">
                <h3 style="color: #ffffff; margin-bottom: 15px;">
                    <i class="fas fa-cloud"></i> AWS BaÄŸlantÄ± Testi
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="control-group">
                        <label><i class="fas fa-key"></i> Admin Token</label>
                        <input type="text" id="adminTokenInput" value="test-token" placeholder="Admin token">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="testAWSConnection()">
                        <i class="fas fa-plug"></i> AWS BaÄŸlantÄ±sÄ±nÄ± Test Et
                    </button>
                    <button class="btn btn-secondary" onclick="setAWSCredentials()">
                        <i class="fas fa-cog"></i> AWS Credentials Set Et
                    </button>
                </div>
                <div id="awsConnectionStatus" style="margin-top: 15px; padding: 10px; background: #0a0a0a; border-radius: 8px; font-size: 12px; display: none;"></div>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry info">Sistem baÅŸlatÄ±ldÄ±. Backend API'ye baÄŸlanÄ±lÄ±yor...</div>
            </div>
        </div>
    </div>

    <script>
        // Backend API URL - Otomatik IP algÄ±lama
        function getBackendURL() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // Localhost'tan aÃ§Ä±lÄ±yorsa
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:4000';
            }
            
            // File protocol ile aÃ§Ä±lÄ±yorsa (file://) - Production backend kullan
            // Chrome file:// protokolÃ¼nden yapÄ±lan fetch isteklerini CORS nedeniyle engelleyebilir
            // Web server kullanmak daha gÃ¼venli: python3 -m http.server 8000
            if (protocol === 'file:') {
                // Production backend URL'i kullan
                return 'http://107.23.178.153:4000';
            }
            
            // Production domain'den aÃ§Ä±lÄ±yorsa
            if (hostname === 'basvideo.com' || hostname.includes('basvideo.com')) {
                return 'http://107.23.178.153:4000';
            }
            
            // Web server Ã¼zerinden aÃ§Ä±lÄ±yorsa - Production backend kullan
            return 'http://107.23.178.153:4000';
        }
        
        const API_BASE_URL = getBackendURL();
        console.log('ğŸ”— Backend URL:', API_BASE_URL);
        console.log('ğŸ“ Current URL:', window.location.href);
        console.log('ğŸ“ Protocol:', window.location.protocol);
        console.log('ğŸ“ Hostname:', window.location.hostname);
        
        let currentRoomId = 'videosat-showroom-2024';
        let currentChannelId = null;
        let currentIVSPlayer = null;
        let myChannelInfo = null;
        
        // Browser Stream Variables
        let broadcastSession = null;
        let localStream = null;
        let isStreaming = false;
        let isMuted = false;
        let isVideoEnabled = true;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Sayfa yÃ¼klendi, backend baÄŸlantÄ±sÄ± kontrol ediliyor...');
            updateRoomIdInput();
            
            // Hemen backend kontrolÃ¼ baÅŸlat
            setTimeout(() => {
                checkBackendConnection().then(connected => {
                    if (connected) {
                        console.log('âœ… Backend baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±, kanallar yÃ¼kleniyor...');
                        loadChannels();
                        // Auto-refresh channels every 5 seconds (sadece baÄŸlantÄ± baÅŸarÄ±lÄ±ysa)
                        setInterval(loadChannels, 5000);
                    } else {
                        console.error('âŒ Backend baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z!');
                        // BaÄŸlantÄ± baÅŸarÄ±sÄ±zsa her 10 saniyede bir tekrar dene
                        setInterval(() => {
                            checkBackendConnection().then(connected => {
                                if (connected) {
                                    console.log('âœ… Backend baÄŸlantÄ±sÄ± kuruldu!');
                                    loadChannels();
                                }
                            });
                        }, 10000);
                    }
                }).catch(err => {
                    console.error('Backend connection check error:', err);
                });
            }, 500); // 500ms gecikme - sayfa tam yÃ¼klensin
        });

        function updateRoomIdInput() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) {
                currentRoomId = roomId;
                document.getElementById('roomIdInput').value = roomId;
            }
        }

        async function checkBackendConnection() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-circle"></i> BaÄŸlantÄ± Kontrol Ediliyor...';
                statusEl.style.background = '#3b82f6';
            }
            
            try {
                addLog(`Backend baÄŸlantÄ±sÄ± kontrol ediliyor: ${API_BASE_URL}...`, 'info');
                console.log('ğŸ”„ Fetch baÅŸlatÄ±lÄ±yor:', `${API_BASE_URL}/api/health`);
                
                // Timeout ekle (10 saniye)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.error('â±ï¸ Fetch timeout! 10 saniye iÃ§inde yanÄ±t alÄ±namadÄ±');
                    controller.abort();
                }, 10000);
                
                console.log('ğŸ“¡ Fetch URL:', `${API_BASE_URL}/api/health`);
                console.log('ğŸ“¡ Fetch options:', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    cache: 'no-cache'
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                console.log('ğŸ“¡ Response headers:', Object.fromEntries(response.headers.entries()));
                
                clearTimeout(timeoutId);
                console.log('âœ… Fetch baÅŸarÄ±lÄ±:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('âœ… Response data:', data);
                if (data.ok) {
                    updateConnectionStatus('success', 'Backend BaÄŸlÄ±');
                    addLog('âœ… Backend API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±', 'success');
                    return true;
                } else {
                    throw new Error('Backend not responding correctly');
                }
            } catch (error) {
                console.error('âŒ Backend connection error:', error);
                console.error('âŒ Error name:', error.name);
                console.error('âŒ Error message:', error.message);
                console.error('âŒ Error stack:', error.stack);
                
                let errorMessage = 'Bilinmeyen hata';
                
                if (error.name === 'AbortError') {
                    updateConnectionStatus('error', 'BaÄŸlantÄ± Zaman AÅŸÄ±mÄ±');
                    errorMessage = 'Backend\'e baÄŸlanÄ±lamadÄ± (10 saniye timeout)';
                    addLog('âŒ ' + errorMessage, 'error');
                    addLog(`Backend URL: ${API_BASE_URL}`, 'info');
                    addLog('Kontrol: Backend Ã§alÄ±ÅŸÄ±yor mu? Terminal\'de: curl http://localhost:4000/api/health', 'info');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('Network request failed')) {
                    updateConnectionStatus('error', 'AÄŸ HatasÄ±');
                    errorMessage = 'AÄŸ hatasÄ± - Backend eriÅŸilemiyor. CORS veya network sorunu olabilir.';
                    addLog('âŒ ' + errorMessage, 'error');
                    addLog(`Backend URL: ${API_BASE_URL}`, 'info');
                    addLog(`Sayfa URL: ${window.location.href}`, 'info');
                    addLog('Kontrol: Backend Ã§alÄ±ÅŸÄ±yor mu? â†’ curl http://localhost:4000/api/health', 'info');
                } else {
                    updateConnectionStatus('error', 'Backend BaÄŸlantÄ± HatasÄ±');
                    errorMessage = `Backend baÄŸlantÄ± hatasÄ±: ${error.message}`;
                    addLog(`âŒ ${errorMessage}`, 'error');
                    addLog(`Backend URL: ${API_BASE_URL}`, 'info');
                }
                
                // Ek debug bilgisi
                addLog(`ğŸ” Debug: Protocol=${window.location.protocol}, Hostname=${window.location.hostname}`, 'info');
                
                return false;
            }
        }

        function updateConnectionStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            status.innerHTML = `<i class="fas fa-circle"></i> ${message}`;
            status.style.background = type === 'success' ? '#059669' : '#ef4444';
        }

        // Room OluÅŸtur (Admin)
        async function createRoom() {
            const roomId = document.getElementById('roomIdInput').value || `room-${Date.now()}`;
            const roomName = prompt('Room adÄ±:', `VideoSat Showroom ${new Date().toLocaleDateString()}`);
            
            if (!roomName) return;

            try {
                addLog(`Room oluÅŸturuluyor: ${roomId}...`, 'info');
                
                const response = await fetch(`${API_BASE_URL}/api/rooms/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-token': 'test-token-videosat-2024' // Admin token
                    },
                    body: JSON.stringify({
                        roomId: roomId,
                        name: roomName
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    addLog(`Room oluÅŸturuldu: ${data.roomId}`, 'success');
                    currentRoomId = data.roomId;
                    document.getElementById('roomIdInput').value = data.roomId;
                    loadChannels();
                } else {
                    throw new Error(data.error || 'Room oluÅŸturulamadÄ±');
                }
            } catch (error) {
                addLog(`Room oluÅŸturma hatasÄ±: ${error.message}`, 'error');
                alert('Hata: ' + error.message);
            }
        }

        // YayÄ±ncÄ± Olarak Room'a KatÄ±l
        async function joinRoomAsStreamer() {
            const roomId = document.getElementById('roomIdInput').value;
            const streamerEmail = document.getElementById('streamerEmailInput').value;
            const streamerName = document.getElementById('streamerNameInput').value;
            const deviceInfo = document.getElementById('deviceInfoInput').value;

            if (!streamerEmail) {
                alert('LÃ¼tfen yayÄ±ncÄ± e-posta adresini girin');
                return;
            }

            try {
                addLog(`Room'a katÄ±lÄ±yor: ${streamerEmail}...`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        streamerEmail: streamerEmail,
                        streamerName: streamerName,
                        deviceInfo: deviceInfo
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    myChannelInfo = data;
                    addLog(`Room'a katÄ±ldÄ±! Channel ID: ${data.channelId}`, 'success');
                    addLog(`Ingest: ${data.ingest}`, 'info');
                    addLog(`Stream Key: ${data.streamKey.substring(0, 20)}...`, 'info');
                    addLog(`Playback URL: ${data.playbackUrl}`, 'info');
                    
                    // Stream key'i gÃ¶ster (OBS Studio iÃ§in)
                    showStreamKeyInfo(data);
                    
                    // Channel listesini yenile
                    loadChannels();
                } else {
                    throw new Error(data.error || "Room'a katÄ±lamadÄ±");
                }
            } catch (error) {
                addLog(`Room'a katÄ±lma hatasÄ±: ${error.message}`, 'error');
                alert('Hata: ' + error.message);
            }
        }

        function showStreamKeyInfo(channelData) {
            const info = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   YAYINCI BÄ°LGÄ°LERÄ°                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Channel ID: ${channelData.channelId}
â•‘ 
â•‘ OBS Studio AyarlarÄ±:
â•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘ Server: ${channelData.ingest}
â•‘ Stream Key: ${channelData.streamKey}
â•‘ 
â•‘ Playback URL:
â•‘ ${channelData.playbackUrl}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `;
            console.log(info);
            alert('Channel oluÅŸturuldu! Console\'da detaylarÄ± gÃ¶rebilirsiniz.\n\nOBS Studio veya baÅŸka streaming yazÄ±lÄ±mÄ±nda bu bilgileri kullanarak yayÄ±na baÅŸlayabilirsiniz.\n\nTarayÄ±cÄ±dan direkt yayÄ±n iÃ§in "TarayÄ±cÄ±dan YayÄ±n BaÅŸlat" butonunu kullanÄ±n.');
        }

        // Channel'larÄ± YÃ¼kle
        async function loadChannels() {
            const roomId = document.getElementById('roomIdInput').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/channels`);
                const data = await response.json();

                if (data.ok && data.channels) {
                    renderChannels(data.channels);
                    addLog(`${data.channels.length} aktif channel bulundu`, 'info');
                } else {
                    renderChannels([]);
                }
            } catch (error) {
                addLog(`Channel yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
                renderChannels([]);
            }
        }

        // Channel Listesini Render Et
        function renderChannels(channels) {
            const container = document.getElementById('channelsList');
            
            if (channels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tv"></i>
                        <p>HenÃ¼z kanal yok</p>
                        <p style="font-size: 12px; margin-top: 10px;">YayÄ±ncÄ±lar room'a katÄ±ldÄ±ÄŸÄ±nda burada gÃ¶rÃ¼necek</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = channels.map(channel => `
                <div class="channel-card ${channel.channelId === currentChannelId ? 'active' : ''}" 
                     onclick="watchChannel('${channel.channelId}')">
                    <div class="channel-header">
                        <div class="channel-name">
                            <i class="fas fa-user"></i> ${channel.streamerName || channel.streamerEmail}
                        </div>
                        <div class="channel-status ${channel.status === 'active' ? '' : 'inactive'}">
                            <i class="fas fa-circle"></i> ${channel.status === 'active' ? 'CANLI' : 'PASIF'}
                        </div>
                    </div>
                    <div class="channel-info">
                        <i class="fas fa-mobile-alt"></i> ${channel.deviceInfo || 'Unknown Device'}
                    </div>
                    <div class="channel-info" style="font-size: 10px; color: #666;">
                        <i class="fas fa-clock"></i> ${new Date(channel.createdAt).toLocaleTimeString()}
                    </div>
                </div>
            `).join('');
        }

        // Channel Ä°zle
        async function watchChannel(channelId) {
            const roomId = document.getElementById('roomIdInput').value;
            
            try {
                addLog(`Channel izleniyor: ${channelId}...`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/channels/${channelId}/playback`);
                const data = await response.json();

                if (data.ok && data.playbackUrl) {
                    currentChannelId = channelId;
                    
                    // Channel bilgilerini gÃ¼ncelle
                    document.getElementById('currentChannelName').textContent = data.streamerName || 'YayÄ±ncÄ±';
                    document.getElementById('currentChannelInfo').textContent = `Channel ID: ${channelId}`;
                    document.getElementById('currentPlaybackUrl').textContent = data.playbackUrl;

                    // IVS Player ile oynat
                    playIVSStream(data.playbackUrl);
                    
                    // Channel listesini gÃ¼ncelle (active state)
                    loadChannels();
                    
                    addLog(`Channel izleniyor: ${data.streamerName}`, 'success');
                } else {
                    throw new Error('Channel playback URL alÄ±namadÄ±');
                }
            } catch (error) {
                addLog(`Channel izleme hatasÄ±: ${error.message}`, 'error');
                alert('Hata: ' + error.message);
            }
        }

        // IVS Stream Oynat
        function playIVSStream(playbackUrl) {
            const videoElement = document.getElementById('mainVideo');
            
            try {
                console.log('ğŸ¥ IVS Player baÅŸlatÄ±lÄ±yor:', playbackUrl);
                
                // Ã–nceki player'Ä± temizle
                if (currentIVSPlayer) {
                    console.log('ğŸ”„ Ã–nceki player temizleniyor...');
                    currentIVSPlayer.delete();
                    currentIVSPlayer = null;
                }
                
                // Video element kontrolÃ¼
                if (!videoElement) {
                    console.error('âŒ Video element bulunamadÄ±!');
                    throw new Error('Video element bulunamadÄ±!');
                }
                
                // IVS Player kontrolÃ¼
                if (!window.IVSPlayer) {
                    console.error('âŒ IVS Player SDK yÃ¼klenmedi!');
                    addLog('IVS Player SDK yÃ¼klenmedi. Fallback kullanÄ±lÄ±yor...', 'warning');
                    // Fallback: Native video element
                    videoElement.src = playbackUrl;
                    videoElement.play().catch(err => {
                        console.error('Native video play error:', err);
                        addLog(`Native video oynatma hatasÄ±: ${err.message}`, 'error');
                    });
                    addLog('Native video player ile yayÄ±n baÅŸlatÄ±ldÄ±', 'info');
                    return;
                }
                
                if (!window.IVSPlayer.isPlayerSupported) {
                    console.warn('âš ï¸ IVS Player bu tarayÄ±cÄ±da desteklenmiyor');
                    // Fallback
                    videoElement.src = playbackUrl;
                    videoElement.play().catch(err => {
                        addLog(`Native video oynatma hatasÄ±: ${err.message}`, 'error');
                    });
                    addLog('Native video player ile yayÄ±n baÅŸlatÄ±ldÄ±', 'info');
                    return;
                }
                
                console.log('âœ… IVS Player destekleniyor, player oluÅŸturuluyor...');
                const player = window.IVSPlayer.create();
                player.attachHTMLVideoElement(videoElement);
                console.log('âœ… Video element eklendi, stream yÃ¼kleniyor...');
                
                // Event listeners
                player.addEventListener('ERROR', (event) => {
                    console.error('âŒ IVS Player ERROR:', event);
                    addLog(`YayÄ±n hatasÄ±: ${event.type}`, 'error');
                });
                
                player.addEventListener('PLAYING', () => {
                    console.log('âœ… YayÄ±n baÅŸladÄ±!');
                    addLog('YayÄ±n baÅŸladÄ±', 'success');
                });
                
                player.addEventListener('BUFFERING', () => {
                    console.log('â³ YayÄ±n buffer\'lanÄ±yor...');
                });
                
                player.load(playbackUrl);
                currentIVSPlayer = player;
                
                // Auto-play
                player.play().catch(err => {
                    console.error('Play error:', err);
                    addLog(`Video oynatma hatasÄ±: ${err.message}`, 'error');
                });
                
                addLog('IVS Player ile yayÄ±n baÅŸlatÄ±ldÄ±', 'success');
            } catch (error) {
                addLog(`Stream oynatma hatasÄ±: ${error.message}`, 'error');
            }
        }

        // Log Ekle
        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(entry, container.firstChild);
            
            // Maksimum 50 log entry
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // AWS BaÄŸlantÄ± Testi
        async function testAWSConnection() {
            const adminToken = document.getElementById('adminTokenInput').value;
            const statusDiv = document.getElementById('awsConnectionStatus');
            
            if (!adminToken) {
                alert('LÃ¼tfen admin token girin');
                return;
            }

            try {
                addLog('AWS baÄŸlantÄ±sÄ± test ediliyor...', 'info');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test ediliyor...';
                statusDiv.style.color = '#3b82f6';

                const response = await fetch(`${API_BASE_URL}/api/admin/aws/verify`, {
                    headers: {
                        'x-admin-token': adminToken
                    }
                });

                const data = await response.json();

                if (data.ok) {
                    statusDiv.innerHTML = `
                        <div style="color: #10b981;">
                            <i class="fas fa-check-circle"></i> <strong>AWS BaÄŸlantÄ±sÄ± BaÅŸarÄ±lÄ±!</strong>
                        </div>
                        <div style="margin-top: 10px; color: #999; font-size: 11px;">
                            <div>Account ID: ${data.account}</div>
                            <div>User ID: ${data.userId}</div>
                            <div>Region: ${data.region}</div>
                            <div>IVS Status: ${data.ivsOk ? 'âœ… Aktif' : 'âŒ Pasif'}</div>
                        </div>
                    `;
                    statusDiv.style.color = '#10b981';
                    addLog('AWS baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!', 'success');
                } else {
                    throw new Error(data.error || 'AWS baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="color: #ef4444;">
                        <i class="fas fa-times-circle"></i> <strong>AWS BaÄŸlantÄ± HatasÄ±</strong>
                    </div>
                    <div style="margin-top: 10px; color: #999; font-size: 11px;">
                        ${error.message}<br>
                        <small>Not: AWS credentials .env dosyasÄ±nda veya runtime'da set edilmeli.</small>
                    </div>
                `;
                statusDiv.style.color = '#ef4444';
                addLog(`AWS baÄŸlantÄ± hatasÄ±: ${error.message}`, 'error');
            }
        }

        // AWS Credentials Set Et (Runtime)
        async function setAWSCredentials() {
            const adminToken = document.getElementById('adminTokenInput').value;
            
            if (!adminToken) {
                alert('LÃ¼tfen admin token girin');
                return;
            }

            const accessKeyId = prompt('AWS Access Key ID:');
            if (!accessKeyId) return;

            const secretAccessKey = prompt('AWS Secret Access Key:');
            if (!secretAccessKey) return;

            const region = prompt('AWS Region (varsayÄ±lan: us-east-1):', 'us-east-1') || 'us-east-1';

            try {
                addLog('AWS credentials set ediliyor...', 'info');

                const response = await fetch(`${API_BASE_URL}/api/admin/aws/creds`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-token': adminToken
                    },
                    body: JSON.stringify({
                        accessKeyId: accessKeyId,
                        secretAccessKey: secretAccessKey,
                        region: region
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    addLog(`AWS credentials set edildi. Region: ${data.region}`, 'success');
                    alert('AWS credentials baÅŸarÄ±yla set edildi!');
                    // Otomatik test et
                    setTimeout(() => testAWSConnection(), 500);
                } else {
                    throw new Error(data.error || 'Credentials set edilemedi');
                }
            } catch (error) {
                addLog(`AWS credentials set hatasÄ±: ${error.message}`, 'error');
                alert('Hata: ' + error.message);
            }
        }

        // ===== TARAYICI YAYIN FONKSÄ°YONLARI (OBS Olmadan) =====
        
        // AWS IVS Broadcast SDK'nÄ±n yÃ¼klenmesini bekle
        async function waitForSDK(maxWait = 10000) {
            const startTime = Date.now();
            let attempts = 0;
            
            console.log('ğŸ” SDK kontrol baÅŸlatÄ±ldÄ±...');
            console.log('window.ivsSDKLoaded:', window.ivsSDKLoaded);
            console.log('IVSBroadcastClient:', typeof IVSBroadcastClient);
            console.log('window.IVSBroadcastClient:', typeof window.IVSBroadcastClient);
            console.log('window nesnesinde IVS:', Object.keys(window).filter(k => k.includes('IVS') || k.includes('Broadcast')));
            
            // SDK yÃ¼klenmemiÅŸse bekle
            while (typeof IVSBroadcastClient === 'undefined' && typeof window.IVSBroadcastClient === 'undefined') {
                attempts++;
                if (Date.now() - startTime > maxWait) {
                    console.error('âŒ SDK timeout:', {
                        elapsed: Date.now() - startTime,
                        attempts: attempts,
                        IVSBroadcastClient: typeof IVSBroadcastClient,
                        windowIVS: typeof window.IVSBroadcastClient,
                        allWindowKeys: Object.keys(window).filter(k => k.includes('IVS') || k.includes('Broadcast'))
                    });
                    throw new Error('AWS IVS Broadcast SDK yÃ¼klenemedi! Script CDN\'den yÃ¼klenememiÅŸ olabilir. LÃ¼tfen sayfayÄ± yenileyin veya internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                if (attempts % 10 === 0) {
                    console.log(`â³ SDK bekleniyor... (${attempts * 200}ms geÃ§ti)`);
                }
            }
            
            const sdk = window.IVSBroadcastClient || IVSBroadcastClient;
            console.log('âœ… SDK bulundu:', sdk ? 'EVET' : 'HAYIR');
            return sdk;
        }
        
        // TarayÄ±cÄ±dan YayÄ±n BaÅŸlat
        async function startBrowserStream() {
            if (isStreaming) {
                alert('YayÄ±n zaten devam ediyor!');
                return;
            }
            
            try {
                // 0. SDK'nÄ±n yÃ¼klendiÄŸinden emin ol
                addLog('AWS IVS Broadcast SDK kontrol ediliyor...', 'info');
                const BroadcastClient = await waitForSDK(5000);
                addLog('âœ… SDK yÃ¼klendi', 'success');
                
                addLog('TarayÄ±cÄ± yayÄ±nÄ± baÅŸlatÄ±lÄ±yor...', 'info');
                
                // 1. Ã–nce room'a katÄ±l ve channel bilgilerini al
                const roomId = document.getElementById('roomIdInput').value;
                const streamerEmail = document.getElementById('streamerEmailInput').value;
                const streamerName = document.getElementById('streamerNameInput').value;
                const deviceInfo = document.getElementById('deviceInfoInput').value;
                
                if (!streamerEmail) {
                    alert('LÃ¼tfen yayÄ±ncÄ± e-posta adresini girin');
                    return;
                }
                
                // Room'a katÄ±l
                addLog("Room'a katÄ±lÄ±yor...", 'info');
                console.log('ğŸ“¡ Join request:', {
                    url: `${API_BASE_URL}/api/rooms/${roomId}/join`,
                    method: 'POST',
                    body: { streamerEmail, streamerName, deviceInfo }
                });
                
                const joinResponse = await fetch(`${API_BASE_URL}/api/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    body: JSON.stringify({
                        streamerEmail: streamerEmail,
                        streamerName: streamerName,
                        deviceInfo: deviceInfo || 'Browser'
                    })
                }).catch(err => {
                    console.error('âŒ Fetch error detaylarÄ±:', {
                        name: err.name,
                        message: err.message,
                        stack: err.stack,
                        url: `${API_BASE_URL}/api/rooms/${roomId}/join`
                    });
                    addLog(`âŒ Backend baÄŸlantÄ± hatasÄ±: ${err.message}`, 'error');
                    throw new Error(`Backend'e baÄŸlanÄ±lamadÄ±: ${err.message}. Backend Ã§alÄ±ÅŸÄ±yor mu? â†’ curl http://localhost:4000/api/health`);
                });
                
                if (!joinResponse.ok) {
                    const errorText = await joinResponse.text();
                    console.error('âŒ Join response error:', {
                        status: joinResponse.status,
                        statusText: joinResponse.statusText,
                        body: errorText
                    });
                    throw new Error(`Backend hatasÄ± (${joinResponse.status}): ${errorText}`);
                }
                
                console.log('ğŸ“¡ Join response status:', joinResponse.status);
                
                const joinData = await joinResponse.json();
                
                console.log('ğŸ“¦ Backend response:', joinData);
                
                if (!joinData.ok) {
                    throw new Error(joinData.error || "Room'a katÄ±lamadÄ±");
                }
                
                // Backend'den gelen verileri kontrol et
                if (!joinData.ingest) {
                    console.error('âŒ Backend response eksik:', joinData);
                    throw new Error('Backend\'den gerekli bilgiler alÄ±namadÄ±! ingest eksik.');
                }
                
                // EÄŸer streamKey yoksa (mevcut channel durumunda), tekrar join isteÄŸi gÃ¶nder
                if (!joinData.streamKey) {
                    console.warn('âš ï¸ StreamKey yok, yeni channel oluÅŸturuluyor...');
                    // Bu durumda backend mevcut channel'Ä± dÃ¶ndÃ¼rmÃ¼ÅŸ olabilir
                    // Tekrar join edip yeni channel oluÅŸturmayÄ± dene
                    // VEYA backend'den streamKey'i ayrÄ± bir endpoint ile al
                    throw new Error('StreamKey bulunamadÄ±. Mevcut channel kullanÄ±lÄ±yor olabilir. LÃ¼tfen farklÄ± bir email ile deneyin veya yeni channel oluÅŸturun.');
                }
                
                myChannelInfo = joinData;
                addLog(`Channel oluÅŸturuldu: ${joinData.channelId}`, 'success');
                
                // Mock channel kontrolÃ¼
                if (joinData.ingest && joinData.ingest.includes('mock-ingest')) {
                    throw new Error('Mock channel ile tarayÄ±cÄ±dan yayÄ±n yapÄ±lamaz. LÃ¼tfen "Room\'a KatÄ±l (OBS/Stream Key iÃ§in)" butonunu kullanarak OBS Studio ile yayÄ±n yapÄ±n. AWS hesap doÄŸrulamasÄ± tamamlandÄ±ktan sonra tarayÄ±cÄ±dan yayÄ±n yapabilirsiniz.');
                }
                
                // 2. Kamera ve mikrofon eriÅŸimi
                addLog('Kamera ve mikrofon eriÅŸimi isteniyor...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                });
                
                // Preview video
                const previewVideo = document.getElementById('localPreview');
                previewVideo.srcObject = localStream;
                
                // 3. Broadcast session oluÅŸtur
                addLog('Broadcast session oluÅŸturuluyor...', 'info');
                
                // Ingest endpoint formatÄ±: rtmps://hostname:443/app/
                // Broadcast SDK iÃ§in sadece hostname gerekli
                const ingestUrl = new URL(joinData.ingest);
                const ingestEndpoint = ingestUrl.hostname;
                const streamKey = joinData.streamKey;
                
                console.log('ğŸ“¡ Stream bilgileri:', {
                    ingest: joinData.ingest,
                    ingestEndpoint: ingestEndpoint,
                    streamKeyLength: streamKey ? streamKey.length : 0
                });
                
                if (!streamKey || typeof streamKey !== 'string') {
                    throw new Error(`Stream key alÄ±namadÄ± veya geÃ§ersiz! Type: ${typeof streamKey}, Value: ${streamKey}`);
                }
                
                addLog(`Ingest: ${ingestEndpoint}, Stream Key: ${streamKey.substring(0, 20)}...`, 'info');
                
                // Broadcast client oluÅŸtur (SDK zaten yÃ¼klÃ¼ - fonksiyonun baÅŸÄ±nda alÄ±ndÄ±)
                // NOT: AWS hesabÄ± WebRTC'yi desteklemiyorsa Broadcast SDK Ã§alÄ±ÅŸmaz
                // Bu durumda OBS Studio kullanmak gerekiyor veya AWS hesabÄ±nÄ± doÄŸrulatmak
                try {
                    broadcastSession = BroadcastClient.create({
                        streamConfig: BroadcastClient.STANDARD_LANDSCAPE,
                        ingestEndpoint: ingestEndpoint
                    });
                    console.log('âœ… Broadcast session oluÅŸturuldu');
                } catch (sdkError) {
                    console.error('âŒ Broadcast SDK create hatasÄ±:', sdkError);
                    throw new Error('AWS IVS Broadcast SDK hatasÄ±. HesabÄ±nÄ±z WebRTC modunu desteklemiyor olabilir. OBS Studio kullanÄ±n veya AWS hesabÄ±nÄ±zÄ± doÄŸrulatÄ±n.');
                }
                
                // 5. Video ve audio input'larÄ± ekle
                addLog('Medya akÄ±ÅŸlarÄ± ekleniyor...', 'info');
                
                const videoTracks = localStream.getVideoTracks();
                const audioTracks = localStream.getAudioTracks();
                
                if (videoTracks.length > 0) {
                    broadcastSession.addVideoInputDevice(localStream, 'camera', { index: 0 });
                    addLog('Video input eklendi', 'success');
                }
                
                if (audioTracks.length > 0) {
                    broadcastSession.addAudioInputDevice(localStream, 'microphone');
                    addLog('Audio input eklendi', 'success');
                }
                
                // 6. Stream baÅŸlat
                addLog('YayÄ±n baÅŸlatÄ±lÄ±yor...', 'info');
                
                try {
                    await broadcastSession.startBroadcast(streamKey);
                    console.log('âœ… Broadcast baÅŸlatÄ±ldÄ±');
                } catch (broadcastError) {
                    console.error('âŒ Broadcast start hatasÄ±:', broadcastError);
                    if (broadcastError.message && broadcastError.message.includes('not supported')) {
                        throw new Error('AWS hesabÄ±nÄ±z WebRTC modunu desteklemiyor. LÃ¼tfen "Room\'a KatÄ±l (OBS Ä°Ã§in)" butonunu kullanarak OBS Studio ile yayÄ±n yapÄ±n.');
                    }
                    throw broadcastError;
                }
                
                isStreaming = true;
                document.getElementById('browserStreamControls').style.display = 'block';
                document.getElementById('stopStreamBtn').style.display = 'inline-block';
                document.getElementById('streamStatus').innerHTML = 
                    '<span style="color: #10b981;"><i class="fas fa-circle"></i> CANLI YAYINDA</span><br>' +
                    `Channel: ${joinData.channelId}<br>` +
                    `Playback: <a href="${joinData.playbackUrl}" target="_blank" style="color: #3b82f6;">Ä°zle</a>`;
                
                addLog('âœ… TarayÄ±cÄ± yayÄ±nÄ± baÅŸlatÄ±ldÄ±!', 'success');
                
                // Channel listesini yenile
                loadChannels();
                
            } catch (error) {
                addLog(`âŒ YayÄ±n baÅŸlatma hatasÄ±: ${error.message}`, 'error');
                alert('Hata: ' + error.message);
                
                // Temizlik
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (broadcastSession) {
                    broadcastSession = null;
                }
            }
        }
        
        // YayÄ±nÄ± Durdur
        async function stopBrowserStream() {
            if (!isStreaming) {
                return;
            }
            
            try {
                addLog('YayÄ±n durduruluyor...', 'info');
                
                if (broadcastSession) {
                    try {
                        await broadcastSession.stopBroadcast();
                    } catch (e) {
                        console.error('Stop broadcast error:', e);
                    }
                    broadcastSession = null;
                }
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                const previewVideo = document.getElementById('localPreview');
                previewVideo.srcObject = null;
                
                isStreaming = false;
                document.getElementById('browserStreamControls').style.display = 'none';
                document.getElementById('stopStreamBtn').style.display = 'none';
                document.getElementById('streamStatus').innerHTML = '';
                
                addLog('âœ… YayÄ±n durduruldu', 'success');
                
            } catch (error) {
                addLog(`âŒ YayÄ±n durdurma hatasÄ±: ${error.message}`, 'error');
            }
        }
        
        // Mikrofonu AÃ§/Kapa
        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMuted = !isMuted;
                audioTracks[0].enabled = !isMuted;
                
                const muteBtn = document.getElementById('muteBtn');
                muteBtn.innerHTML = isMuted 
                    ? '<i class="fas fa-microphone-slash"></i> Mikrofonu AÃ§'
                    : '<i class="fas fa-microphone"></i> Mikrofonu Kapat';
                
                muteBtn.style.background = isMuted ? '#dc2626' : '#059669';
            }
        }
        
        // KamerayÄ± AÃ§/Kapa
        function toggleVideo() {
            if (!localStream) return;
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                isVideoEnabled = !isVideoEnabled;
                videoTracks[0].enabled = isVideoEnabled;
                
                const videoBtn = document.getElementById('videoBtn');
                videoBtn.innerHTML = isVideoEnabled
                    ? '<i class="fas fa-video"></i> KamerayÄ± Kapat'
                    : '<i class="fas fa-video-slash"></i> KamerayÄ± AÃ§';
                
                videoBtn.style.background = isVideoEnabled ? '#059669' : '#dc2626';
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (currentIVSPlayer) {
                currentIVSPlayer.delete();
            }
            if (broadcastSession) {
                try {
                    broadcastSession.stopBroadcast().catch(() => {});
                } catch (e) {}
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>

