<!-- Analytics Charts Component -->
<!-- Chart.js ile grafikler -->

<div class="analytics-charts" id="analyticsCharts">
    <!-- Satış Grafikleri -->
    <div class="chart-section">
        <h2 class="chart-title">
            <i class="fas fa-chart-line"></i> Satış Trendleri
        </h2>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- Sipariş Durumu Grafiği -->
    <div class="chart-section">
        <h2 class="chart-title">
            <i class="fas fa-shopping-cart"></i> Sipariş Durumu
        </h2>
        <div class="chart-container">
            <canvas id="orderStatusChart"></canvas>
        </div>
    </div>

    <!-- Ürün Kategorileri -->
    <div class="chart-section">
        <h2 class="chart-title">
            <i class="fas fa-box"></i> Ürün Dağılımı
        </h2>
        <div class="chart-container">
            <canvas id="productChart"></canvas>
        </div>
    </div>

    <!-- Aylık Satış Grafiği -->
    <div class="chart-section">
        <h2 class="chart-title">
            <i class="fas fa-calendar-alt"></i> Aylık Satış Raporu
        </h2>
        <div class="chart-container">
            <canvas id="monthlySalesChart"></canvas>
        </div>
    </div>

    <!-- En Çok Satan Ürünler -->
    <div class="chart-section">
        <h2 class="chart-title">
            <i class="fas fa-trophy"></i> En Çok Satan Ürünler (Top 10)
        </h2>
        <div class="chart-container">
            <canvas id="topProductsChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
.analytics-charts {
    padding: 20px;
}

.chart-section {
    background: #1a1a1a;
    border: 1px solid #dc2626;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
}

.chart-title {
    color: #ffffff;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-title i {
    color: #dc2626;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .analytics-charts {
        padding: 10px;
    }
    
    .chart-section {
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .chart-title {
        font-size: 1.1rem;
    }
}
</style>

<script>
// Chart.js grafikleri oluştur
let salesChart = null;
let orderStatusChart = null;
let productChart = null;
let monthlySalesChart = null;
let topProductsChart = null;

function initializeCharts() {
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js yüklenmedi');
        return;
    }

    // Analytics Service kontrolü
    if (typeof window.analyticsService === 'undefined') {
        console.warn('Analytics Service yüklenmedi');
        return;
    }

    const stats = window.analyticsService.getStats();

    // Satış Trendleri Grafiği
    createSalesChart(stats);
    
    // Sipariş Durumu Grafiği
    createOrderStatusChart(stats);
    
    // Ürün Dağılımı Grafiği
    createProductChart(stats);
    
    // Aylık Satış Grafiği
    createMonthlySalesChart(stats);
    
    // En Çok Satan Ürünler
    createTopProductsChart();
}

// Satış Trendleri Grafiği
function createSalesChart(stats) {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;

    if (salesChart) {
        salesChart.destroy();
    }

    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Bugün', 'Bu Hafta', 'Bu Ay', 'Bu Yıl', 'Toplam'],
            datasets: [{
                label: 'Satış (₺)',
                data: [
                    stats.sales.today,
                    stats.sales.week,
                    stats.sales.month,
                    stats.sales.year,
                    stats.sales.total
                ],
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af',
                        callback: function(value) {
                            return '₺' + value.toLocaleString('tr-TR');
                        }
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// Sipariş Durumu Grafiği
function createOrderStatusChart(stats) {
    const ctx = document.getElementById('orderStatusChart');
    if (!ctx) return;

    if (orderStatusChart) {
        orderStatusChart.destroy();
    }

    orderStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Bekleyen', 'Tamamlanan', 'İptal Edilen'],
            datasets: [{
                data: [
                    stats.orders.pending,
                    stats.orders.completed,
                    stats.orders.cancelled
                ],
                backgroundColor: [
                    '#f59e0b',
                    '#22c55e',
                    '#ef4444'
                ],
                borderColor: '#1a1a1a',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        padding: 15
                    }
                }
            }
        }
    });
}

// Ürün Dağılımı Grafiği
function createProductChart(stats) {
    const ctx = document.getElementById('productChart');
    if (!ctx) return;

    if (productChart) {
        productChart.destroy();
    }

    const inStock = stats.products.total - stats.products.lowStock - stats.products.outOfStock;

    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Stokta', 'Düşük Stok', 'Tükendi'],
            datasets: [{
                label: 'Ürün Sayısı',
                data: [
                    inStock,
                    stats.products.lowStock,
                    stats.products.outOfStock
                ],
                backgroundColor: [
                    '#22c55e',
                    '#f59e0b',
                    '#ef4444'
                ],
                borderColor: '#1a1a1a',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af',
                        stepSize: 1
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// Aylık Satış Grafiği
function createMonthlySalesChart(stats) {
    const ctx = document.getElementById('monthlySalesChart');
    if (!ctx) return;

    if (monthlySalesChart) {
        monthlySalesChart.destroy();
    }

    // Son 6 ay
    const months = [];
    const salesData = [];
    const now = new Date();
    
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push(date.toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' }));
        
        // Bu ay için satış hesapla (basit simülasyon)
        const monthSales = stats.sales.month / 6; // Basit dağılım
        salesData.push(Math.round(monthSales));
    }

    monthlySalesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Aylık Satış (₺)',
                data: salesData,
                backgroundColor: 'rgba(220, 38, 38, 0.6)',
                borderColor: '#dc2626',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af',
                        callback: function(value) {
                            return '₺' + value.toLocaleString('tr-TR');
                        }
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                }
            }
        }
    });
}

// En Çok Satan Ürünler Grafiği
function createTopProductsChart() {
    const ctx = document.getElementById('topProductsChart');
    if (!ctx) return;

    if (topProductsChart) {
        topProductsChart.destroy();
    }

    // Analytics Service'den en çok satan ürünleri al
    const topProducts = window.analyticsService.getTopProducts(10);

    if (topProducts.length === 0) {
        // Boş grafik göster
        topProductsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Henüz veri yok'],
                datasets: [{
                    label: 'Satış',
                    data: [0],
                    backgroundColor: '#374151'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        return;
    }

    const labels = topProducts.map(p => p.productName.length > 20 ? p.productName.substring(0, 20) + '...' : p.productName);
    const quantities = topProducts.map(p => p.quantity);
    const revenues = topProducts.map(p => p.revenue);

    topProductsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Satılan Miktar',
                    data: quantities,
                    backgroundColor: 'rgba(220, 38, 38, 0.6)',
                    borderColor: '#dc2626',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: 'Gelir (₺)',
                    data: revenues,
                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                    borderColor: '#22c55e',
                    borderWidth: 1,
                    yAxisID: 'y1',
                    type: 'line'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af',
                        stepSize: 1
                    },
                    grid: {
                        color: '#374151'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    ticks: {
                        color: '#9ca3af',
                        callback: function(value) {
                            return '₺' + value.toLocaleString('tr-TR');
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Grafikleri güncelle
function updateCharts() {
    if (typeof window.analyticsService === 'undefined') {
        return;
    }

    const stats = window.analyticsService.getStats();

    if (salesChart) {
        salesChart.data.datasets[0].data = [
            stats.sales.today,
            stats.sales.week,
            stats.sales.month,
            stats.sales.year,
            stats.sales.total
        ];
        salesChart.update();
    }

    if (orderStatusChart) {
        orderStatusChart.data.datasets[0].data = [
            stats.orders.pending,
            stats.orders.completed,
            stats.orders.cancelled
        ];
        orderStatusChart.update();
    }

    if (productChart) {
        const inStock = stats.products.total - stats.products.lowStock - stats.products.outOfStock;
        productChart.data.datasets[0].data = [
            inStock,
            stats.products.lowStock,
            stats.products.outOfStock
        ];
        productChart.update();
    }

    createTopProductsChart();
}

// Sayfa yüklendiğinde grafikleri oluştur
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js ve Analytics Service yüklendiğinde grafikleri oluştur
    const checkInterval = setInterval(() => {
        if (typeof Chart !== 'undefined' && typeof window.analyticsService !== 'undefined') {
            initializeCharts();
            
            // Her 30 saniyede bir güncelle
            setInterval(updateCharts, 30000);
            
            clearInterval(checkInterval);
        }
    }, 500);
});
</script>

