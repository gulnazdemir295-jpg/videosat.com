<!-- Admin Dashboard Component -->
<!-- Admin panel komponenti -->

<div class="admin-dashboard" id="adminDashboard">
    <div class="admin-header">
        <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
        <div class="admin-actions">
            <button class="btn btn-primary" id="refreshStatsBtn">
                <i class="fas fa-sync-alt"></i> Yenile
            </button>
            <button class="btn btn-secondary" id="exportDataBtn">
                <i class="fas fa-download"></i> Dışa Aktar
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <!-- Users Stats -->
        <div class="stat-card users">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>Kullanıcılar</h3>
                <p class="stat-value" id="usersTotal">-</p>
                <p class="stat-label">Toplam Kullanıcı</p>
            </div>
        </div>

        <!-- Payments Stats -->
        <div class="stat-card payments">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <h3>Ödemeler</h3>
                <p class="stat-value" id="paymentsTotal">-</p>
                <p class="stat-label">Toplam Ödeme</p>
            </div>
        </div>

        <!-- Errors Stats -->
        <div class="stat-card errors">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h3>Hatalar</h3>
                <p class="stat-value" id="errorsTotal">-</p>
                <p class="stat-label">Toplam Hata</p>
            </div>
        </div>

        <!-- Performance Stats -->
        <div class="stat-card performance">
            <div class="stat-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="stat-content">
                <h3>Performans</h3>
                <p class="stat-value" id="performanceAvg">-</p>
                <p class="stat-label">Ortalama Yükleme</p>
            </div>
        </div>

        <!-- Streams Stats -->
        <div class="stat-card streams">
            <div class="stat-icon">
                <i class="fas fa-video"></i>
            </div>
            <div class="stat-content">
                <h3>Yayınlar</h3>
                <p class="stat-value" id="streamsTotal">-</p>
                <p class="stat-label">Aktif Yayın</p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
        <button class="tab-btn active" data-tab="users">
            <i class="fas fa-users"></i> Kullanıcılar
        </button>
        <button class="tab-btn" data-tab="errors">
            <i class="fas fa-exclamation-triangle"></i> Hatalar
        </button>
        <button class="tab-btn" data-tab="performance">
            <i class="fas fa-chart-line"></i> Performans
        </button>
        <button class="tab-btn" data-tab="logs">
            <i class="fas fa-file-alt"></i> Loglar
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Users Tab -->
        <div class="tab-pane active" id="usersTab">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Kayıt Tarihi</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5" class="loading">Yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Errors Tab -->
        <div class="tab-pane" id="errorsTab">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Mesaj</th>
                            <th>Tip</th>
                            <th>Dosya</th>
                            <th>Satır</th>
                        </tr>
                    </thead>
                    <tbody id="errorsTableBody">
                        <tr>
                            <td colspan="5" class="loading">Yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Tab -->
        <div class="tab-pane" id="performanceTab">
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>URL</th>
                            <th>Yükleme (ms)</th>
                            <th>DNS (ms)</th>
                            <th>TCP (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="performanceTableBody">
                        <tr>
                            <td colspan="5" class="loading">Yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-pane" id="logsTab">
            <div class="logs-container">
                <div class="logs-header">
                    <h3>Sistem Logları</h3>
                    <button class="btn btn-sm" id="clearLogsBtn">
                        <i class="fas fa-trash"></i> Temizle
                    </button>
                </div>
                <div class="logs-content" id="logsContent">
                    <p class="loading">Loglar yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.admin-dashboard {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #dc2626;
}

.admin-header h1 {
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 12px;
}

.admin-actions {
    display: flex;
    gap: 12px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #1a1a1a;
    border: 2px solid #dc2626;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.stat-icon {
    font-size: 2.5rem;
    color: #dc2626;
}

.stat-content h3 {
    color: #ffffff;
    margin: 0 0 8px 0;
    font-size: 0.875rem;
    font-weight: 500;
}

.stat-value {
    color: #dc2626;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
}

.stat-label {
    color: #999;
    font-size: 0.75rem;
    margin: 4px 0 0 0;
}

.admin-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 2px solid #2a2a2a;
}

.tab-btn {
    background: transparent;
    border: none;
    color: #999;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    color: #ffffff;
}

.tab-btn.active {
    color: #dc2626;
    border-bottom-color: #dc2626;
}

.tab-content {
    min-height: 400px;
}

.tab-pane {
    display: none;
}

.tab-pane.active {
    display: block;
}

.table-container {
    overflow-x: auto;
    background: #1a1a1a;
    border-radius: 8px;
    border: 1px solid #2a2a2a;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table thead {
    background: #2a2a2a;
}

.admin-table th {
    padding: 12px;
    text-align: left;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.875rem;
}

.admin-table td {
    padding: 12px;
    color: #cccccc;
    font-size: 0.875rem;
    border-top: 1px solid #2a2a2a;
}

.admin-table tbody tr:hover {
    background: #2a2a2a;
}

.admin-table .loading {
    text-align: center;
    color: #999;
    padding: 40px;
}

.logs-container {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 20px;
}

.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #2a2a2a;
}

.logs-header h3 {
    color: #ffffff;
    margin: 0;
}

.logs-content {
    max-height: 500px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #cccccc;
    line-height: 1.6;
}

.log-entry {
    padding: 8px;
    margin-bottom: 4px;
    border-left: 3px solid #dc2626;
    padding-left: 12px;
}

.log-entry.error {
    border-left-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.log-entry.warning {
    border-left-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
}

.log-entry.info {
    border-left-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-tabs {
        flex-wrap: wrap;
    }
}
</style>

<script>
// Admin Dashboard Controller
class AdminDashboardController {
    constructor() {
        this.adminService = null;
        this.currentTab = 'users';
        this.init();
    }

    init() {
        // Check for admin service
        if (typeof window.adminDashboardService === 'undefined') {
            console.warn('Admin Dashboard Service yüklenmedi');
            return;
        }

        this.adminService = window.adminDashboardService;
        
        // Check if user is admin
        if (!this.adminService.isAdmin) {
            document.getElementById('adminDashboard').innerHTML = 
                '<div class="error-message"><h2>Yetkisiz Erişim</h2><p>Bu sayfaya erişim yetkiniz yok.</p></div>';
            return;
        }

        this.setupEventListeners();
        this.loadInitialData();
    }

    setupEventListeners() {
        // Tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                this.switchTab(tab);
            });
        });

        // Refresh button
        document.getElementById('refreshStatsBtn')?.addEventListener('click', () => {
            this.refreshStats();
        });

        // Export button
        document.getElementById('exportDataBtn')?.addEventListener('click', () => {
            this.exportData();
        });

        // Clear logs button
        document.getElementById('clearLogsBtn')?.addEventListener('click', () => {
            this.clearLogs();
        });

        // Admin service event listeners
        this.adminService.on('userStatsUpdated', (data) => {
            this.updateUserStats(data);
        });

        this.adminService.on('errorStatsUpdated', (data) => {
            this.updateErrorStats(data);
        });

        this.adminService.on('performanceStatsUpdated', (data) => {
            this.updatePerformanceStats(data);
        });
    }

    switchTab(tab) {
        this.currentTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        
        // Update tab panes
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.toggle('active', pane.id === `${tab}Tab`);
        });
        
        // Load tab data
        this.loadTabData(tab);
    }

    loadInitialData() {
        this.refreshStats();
        this.loadTabData(this.currentTab);
    }

    async refreshStats() {
        if (this.adminService) {
            await this.adminService.loadAllStats();
        }
    }

    async loadTabData(tab) {
        switch (tab) {
            case 'users':
                await this.loadUsers();
                break;
            case 'errors':
                await this.loadErrors();
                break;
            case 'performance':
                await this.loadPerformance();
                break;
            case 'logs':
                this.loadLogs();
                break;
        }
    }

    async loadUsers() {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading">Yükleniyor...</td></tr>';
        
        const data = await this.adminService.getUsers(50, 0);
        if (data && data.users) {
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.email || '-'}</td>
                    <td>${user.role || '-'}</td>
                    <td>${user.status || '-'}</td>
                    <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="console.log('Edit user:', '${user.email}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Kullanıcı bulunamadı</td></tr>';
        }
    }

    async loadErrors() {
        const tbody = document.getElementById('errorsTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading">Yükleniyor...</td></tr>';
        
        const data = await this.adminService.getErrors(100, 0);
        if (data && data.errors) {
            tbody.innerHTML = data.errors.map(error => `
                <tr>
                    <td>${error.timestamp ? new Date(error.timestamp).toLocaleString('tr-TR') : '-'}</td>
                    <td>${error.message || '-'}</td>
                    <td>${error.type || '-'}</td>
                    <td>${error.filename || '-'}</td>
                    <td>${error.lineno || '-'}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Hata bulunamadı</td></tr>';
        }
    }

    async loadPerformance() {
        const tbody = document.getElementById('performanceTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="loading">Yükleniyor...</td></tr>';
        
        const data = await this.adminService.getPerformanceMetrics(100, 0);
        if (data && data.metrics) {
            tbody.innerHTML = data.metrics.map(metric => `
                <tr>
                    <td>${metric.timestamp ? new Date(metric.timestamp).toLocaleString('tr-TR') : '-'}</td>
                    <td>${metric.url || '-'}</td>
                    <td>${metric.load ? Math.round(metric.load) : '-'}</td>
                    <td>${metric.dns ? Math.round(metric.dns) : '-'}</td>
                    <td>${metric.tcp ? Math.round(metric.tcp) : '-'}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Performans metrikleri bulunamadı</td></tr>';
        }
    }

    loadLogs() {
        const content = document.getElementById('logsContent');
        content.innerHTML = '<p class="loading">Loglar yükleniyor...</p>';
        
        // Simulated logs (in production, fetch from backend)
        setTimeout(() => {
            const logs = [
                { level: 'info', message: 'Sistem başlatıldı', timestamp: new Date().toISOString() },
                { level: 'info', message: 'Veritabanı bağlantısı kuruldu', timestamp: new Date().toISOString() },
                { level: 'warning', message: 'Yüksek bellek kullanımı tespit edildi', timestamp: new Date().toISOString() },
                { level: 'error', message: 'API isteği başarısız oldu', timestamp: new Date().toISOString() }
            ];
            
            content.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level}">
                    <strong>[${new Date(log.timestamp).toLocaleString('tr-TR')}]</strong> ${log.message}
                </div>
            `).join('');
        }, 500);
    }

    updateUserStats(data) {
        if (data && data.total !== undefined) {
            document.getElementById('usersTotal').textContent = data.total;
        }
    }

    updateErrorStats(data) {
        if (data && data.stats && data.stats.total !== undefined) {
            document.getElementById('errorsTotal').textContent = data.stats.total;
        }
    }

    updatePerformanceStats(data) {
        if (data && data.stats && data.stats.averageLoadTime !== undefined) {
            document.getElementById('performanceAvg').textContent = 
                `${Math.round(data.stats.averageLoadTime)}ms`;
        }
    }

    async exportData() {
        const format = prompt('Dışa aktarma formatı (json/csv):', 'json');
        if (format) {
            await this.adminService.exportData(this.currentTab, format);
        }
    }

    clearLogs() {
        if (confirm('Logları temizlemek istediğinize emin misiniz?')) {
            document.getElementById('logsContent').innerHTML = '<p>Loglar temizlendi</p>';
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('adminDashboard')) {
        window.adminDashboardController = new AdminDashboardController();
    }
});
</script>

